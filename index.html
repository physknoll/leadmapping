<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Business Map with Google Sheets</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        #map { height: 600px; width: 100%; }
        body { font-family: Arial, sans-serif; }
        .popup-content {
            width: 250px;
        }
        .contact-button, .save-button, .copy-button {
            margin-top: 5px;
            padding: 5px 10px;
            cursor: pointer;
        }
        .contacted {
            background-color: green;
            color: white;
        }
        .not-contacted {
            background-color: red;
            color: white;
        }
        .notes-area {
            width: 100%;
            height: 60px;
            resize: vertical;
        }
        .status-text {
            font-weight: bold;
        }
    </style>
</head>
<body>

<h2>Business Map with Google Sheets</h2>
<div id="map"></div>

<script>
    // Replace with your Web App URL
    var scriptURL = 'https://script.google.com/macros/s/AKfycbwZP1gzceLMjSCzpNMS1biHrMNf4mxJPTZIhqPQ7Aai2Q47S032HfUcsVB7dulqTAKT/exec';

    // Initialize the map
    var map = L.map('map').setView([39.8283, -98.5795], 4); // Centered on USA

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
    }).addTo(map);

    // Marker storage
    var markers = {};

    // Custom Icons
    var redIcon = new L.Icon({
        iconUrl: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
    });
    var greenIcon = new L.Icon({
        iconUrl: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
    });

    // Fetch data from Google Sheets
    fetch(scriptURL + '?action=getData')
        .then(response => response.json())
        .then(data => addMarkers(data))
        .catch(error => console.error('Error:', error));

    // Function to add markers to the map
    function addMarkers(data) {
        data.forEach(function(row) {
            var lat = parseFloat(row.latitude);
            var lon = parseFloat(row.longitude);

            if (!isNaN(lat) && !isNaN(lon)) {
                var markerIcon = row.status === 'Contacted' ? greenIcon : redIcon;
                var marker = L.marker([lat, lon], { icon: markerIcon }).addTo(map);

                // Store data in marker options
                marker.options.status = row.status || 'Not Contacted';
                marker.options.notes = row.notes || '';
                marker.options.place_id = row.place_id;

                // Popup content
                var popupContent = '<div class="popup-content">' +
                    '<b>' + row.name + '</b><br>' +
                    row.full_address + '<br>' +
                    'Phone: <a href="tel:' + row.phone + '">' + row.phone + '</a><br>' +
                    '<button class="copy-button" data-phone="' + row.phone + '">Copy Phone Number</button><br>' +
                    'Status: <span class="status-text">' + marker.options.status + '</span><br>' +
                    '<button class="contact-button">' + (marker.options.status === 'Contacted' ? 'Mark as Not Contacted' : 'Mark as Contacted') + '</button><br>' +
                    'Notes:<br>' +
                    '<textarea class="notes-area">' + marker.options.notes + '</textarea><br>' +
                    '<button class="save-button">Save</button>' +
                    '</div>';

                marker.bindPopup(popupContent);

                // Store marker with unique ID (e.g., place_id)
                markers[row.place_id] = marker;

                // Event listener for popup open
                marker.on('popupopen', function(e) {
                    var container = e.popup._contentNode;

                    var button = container.querySelector('.contact-button');
                    var saveButton = container.querySelector('.save-button');
                    var notesArea = container.querySelector('.notes-area');
                    var copyButton = container.querySelector('.copy-button');
                    var statusText = container.querySelector('.status-text');

                    button.addEventListener('click', function() {
                        toggleContactStatus(marker, button, statusText);
                    });

                    saveButton.addEventListener('click', function() {
                        saveNotes(marker, notesArea);
                    });

                    copyButton.addEventListener('click', function() {
                        copyToClipboard(row.phone);
                    });
                });
            }
        });
    }

    // Function to toggle contact status
    function toggleContactStatus(marker, button, statusText) {
        var place_id = marker.options.place_id;
        var newStatus = marker.options.status === 'Not Contacted' ? 'Contacted' : 'Not Contacted';
        marker.options.status = newStatus;
        button.textContent = newStatus === 'Contacted' ? 'Mark as Not Contacted' : 'Mark as Contacted';
        statusText.textContent = newStatus;
        marker.setIcon(newStatus === 'Contacted' ? greenIcon : redIcon);

        // Update status in Google Sheets
        var url = scriptURL + '?action=updateData&place_id=' + encodeURIComponent(place_id) + '&status=' + encodeURIComponent(newStatus);
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                return response.text();
            })
            .then(data => console.log('Status updated'))
            .catch(error => {
                alert('There was a problem updating the status: ' + error.message);
            });
    }

    // Function to save notes
    function saveNotes(marker, notesArea) {
        var place_id = marker.options.place_id;
        var notes = notesArea.value;
        marker.options.notes = notes;

        // Disable the save button to prevent multiple clicks
        var saveButton = notesArea.parentElement.querySelector('.save-button');
        saveButton.disabled = true;

        // Update notes in Google Sheets
        var url = scriptURL + '?action=updateData&place_id=' + encodeURIComponent(place_id) + '&notes=' + encodeURIComponent(notes);
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                return response.text();
            })
            .then(data => {
                alert('Notes saved');
                saveButton.disabled = false;
            })
            .catch(error => {
                alert('There was a problem saving the notes: ' + error.message);
                saveButton.disabled = false;
            });
    }

    // Function to copy phone number to clipboard
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(function() {
            alert('Phone number copied to clipboard');
        }, function(err) {
            console.error('Could not copy text: ', err);
        });
    }
</script>

</body>
</html>
